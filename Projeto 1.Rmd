---
title: "Projeto 1"
author: "Tamiris Burin"
---

```{r}
library(devtools)
library(tidyverse)
library(mlr3verse)
library(igraph)
library(quanteda)
library(janitor)
library(tibble)
library(earth)
library(mlr3extralearners)
library(quanteda)
library(kknn)

devtools::install_github("https://github.com/mlr-org/mlr3extralearners")
```

```{r}
link <- "https://github.com/FLS-6497/datasets/blob/main/projeto1/discursos_pres_internacionais.csv?raw=true"
discursos <- readr::read_csv2(link) %>% 
  mutate(id = row_number())
```

```{r}
modelo_tami1 <- function(df, var) {
# 1) Cria um corpus
cps <- corpus(df, text_field = var)

# 2) Tokenizacao
tks <- tokens(cps, remove_punct = TRUE, remove_numbers = TRUE) %>%
  tokens_tolower() %>%
  tokens_remove(pattern = stopwords("pt"), min_nchar=5)

# 3) Criacao de uma matriz bag-of-words
bow <- dfm(tks) %>%
  dfm_trim(min_docfreq = 0.05, docfreq_type = "prop")

# 4) Transformar o resultado para tibble para o mlr3
dados <- as.matrix(bow) %>%
  as_tibble() %>% 
  janitor::clean_names() %>% 
  mutate_all(as.numeric)

#Resutado da matrix
dados$y <- df$presidente
return(list(df = dados, bow = bow))

}

modelo_tami1(df=discursos, var = "discurso")
```

```{r}
discursostreino <- discursos %>% 
  sample_frac(0.7)

discursosteste <- discursos %>% 
  filter(!id %in% discursostreino$id) 

discursostreinobow <- modelo_tami1(df=discursostreino, var= "discurso")

#Adequar a base de teste
discursostestebow <- discursosteste %>% 
  corpus(text_field = "discurso") %>% 
  tokens() %>% 
  dfm() %>% 
  dfm_match(featnames(discursostreinobow$bow)) %>%
  as.matrix() %>% 
  as_tibble() %>% 
  janitor::clean_names()%>% 
  mutate_all(as.numeric)

discursostestebow$y <- as.factor(discursosteste$presidente)

#Treina 
tsk <- as_task_classif(y ~.,data=discursostreinobow$df)
learner <- lrn("classif.naive_bayes")
learner$train(tsk)

pred <- learner$predict_newdata(discursostestebow)
pred

discursosteste$predicao <- pred$response
discursosteste
head(cbind(discursosteste$presidente, as.character(discursosteste$predicao)),10)

#Confere predicoes com metricas de validacao
pred$confusion
pred$score(msrs(c("classif.precision", "classif.recall", "classif.fbeta")))
